---
title: "ACFR Overview"
author: "Mariana F Trujillo"
date: "April 2024"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(rio)
library(ggridges)
library(ggpattern)
library(ggdist)
library(ggbeeswarm)
library(ggstream)
library(ggpubr)
library(scales)
library(knitr)
library(reactable)
library(htmltools)
library(zoo)
library(quantmod)
library(PerformanceAnalytics)
library(quadprog)
library(janitor)
library(kableExtra)
library(patchwork)
library(showtext)
library(RColorBrewer)
library(reshape2)
library(tools)

knitr::opts_chunk$set(warning = FALSE)

States3y <- read.csv("all_states_3years.csv")
Cities3y <- read.csv("top100_cities.csv")
Counties3y <- read.csv("top100_counties.csv")
SD3y_v1 <- read.csv("top100_sd.csv")
SD3y_v2 <- read.csv("top100_sd_3years.csv")
CensusStates <- read.csv("CensusStates.csv")
CensusCities_Counties <- read.csv("CensusCities_Conties.csv")

StateGDP <- read_xlsx("State_GDP.xlsx")

PartisanS<- read.csv("partisan_lean_STATES.csv")


source("APR functions.R")
source("Pension projection functions.R")
source("Reason theme.R")

knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  fig.align = "center",
  cache = FALSE
)

options(scipen = 999)

```

```{r, echo=FALSE}
States3y <- States3y %>%
  mutate(npl_per_capita = net_pension_liability / population,
         employee_debt = net_pension_liability + net_opeb_liability + compensated_absences,
         employee_debt_per_capita = (net_pension_liability + net_opeb_liability)/ population,
         budget_deficit = revenues - expenses) 

Cities3y  <- Cities3y %>%
    mutate(npl_per_capita = net_pension_liability / population,
         employee_debt = net_pension_liability + net_opeb_liability + compensated_absences,
         employee_debt_per_capita = (net_pension_liability + net_opeb_liability)/ population,
         budget_deficit = revenues - expenses) 

Counties3y <- Counties3y %>%
  mutate(npl_per_capita = net_pension_liability / population,
         employee_debt = net_pension_liability + net_opeb_liability + compensated_absences,
         employee_debt_per_capita = (net_pension_liability + net_opeb_liability)/ population,
         budget_deficit = revenues - expenses) 


SD3y_v1 <- SD3y_v1 %>%
  mutate(npl_per_student= net_pension_liability / enrollment_22,
         employee_debt = net_pension_liability + net_opeb_liability + compensated_absences,
         employee_debt_per_capita = (net_pension_liability + net_opeb_liability)/ enrollment_22,
         budget_deficit = revenues - expenses) 


name_data <- SD3y_v2 %>% select(id, name)

SD3y <- left_join(SD3y_v1, name_data, by = "id")
SD3y <- SD3y %>% rename(name = name.y)


```



# Employee Debt 

```{r, echo=FALSE}

Employee_debt_combined <- bind_rows(
  States3y %>% mutate(Dataset = "State"),
  SD3y %>% mutate(Dataset = "SD"),
  Cities3y %>% mutate(Dataset = "City"),
  Counties3y %>% mutate(Dataset = "County")
) %>%
select(Dataset, employee_debt, employee_debt_per_capita, year)

ggplot(Employee_debt_combined, aes(x = Dataset, y = employee_debt, fill = factor(year))) +
  geom_col(position = "dodge") +
  labs(
    title = "Employee Debt by Entity",
    x = "Entity",
    y = "Employee Debt (NPL + OPEB)",
    fill = "Year"
  ) +
  scale_fill_manual(values = c("#FDD5A9", "#FC8D82", "#D73043")) +
  theme_minimal() +
  scale_y_continuous(
    labels = label_number(scale = 1 / 1e9, suffix = "B", prefix = "$")
  ) +
  coord_flip() +
  theme_reason()

```
```{r, echo=FALSE}

employee_debt_summary <- Employee_debt_combined %>%
  group_by(Dataset, year) %>%
  summarize(total_employee_debt = sum(employee_debt, na.rm = TRUE))

employee_debt_summary %>%
  kable(caption = "Total Employee Debt by Entity and Year")

```

## Employee Debt Ranking By Entity 

### States
```{r, echo=FALSE}

States3y_sorted <- States3y %>%
  arrange(name, state.abb, year)

States3y_sorted_EmployeeDebt <- States3y_sorted %>%
  group_by(name) %>%
  mutate(
    nominal_difference_ED = last(employee_debt) - first(employee_debt),
    percent_difference_ED = (last(employee_debt) - first(employee_debt)) / first(employee_debt) * 100,
    nominal_difference_ED_c = last(employee_debt_per_capita) - first(employee_debt_per_capita),
    percent_difference_ED_c = (last(employee_debt_per_capita) - first(employee_debt_per_capita)) / first(employee_debt_per_capita) * 100)

States3y_sorted_EmployeeDebt <- States3y_sorted_EmployeeDebt %>%
  mutate(employee_debt_per_capita = as.numeric(employee_debt_per_capita)) %>%
  mutate(npl_per_capita = as.numeric(npl_per_capita))


```


```{r, echo=FALSE}

States3y_sorted_EmployeeDebtsubset <- States3y_sorted_EmployeeDebt %>%
  filter(year == 2022) %>%
  select(name, employee_debt, employee_debt_per_capita, nominal_difference_ED, percent_difference_ED, nominal_difference_ED_c)

States3y_sorted_EmployeeDebt_reactable <- reactable(
  States3y_sorted_EmployeeDebtsubset,
  columns = list(
    name = colDef(
      name = "State Name",
      cell = function(value) tools::toTitleCase(as.character(value))),  
    employee_debt = colDef(
      name = "2022 Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    employee_debt_per_capita = colDef(
      name = "Employee Debt Per Capita",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    nominal_difference_ED = colDef(
      name = "Nominal Change in Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    percent_difference_ED = colDef(
      name = "Percentage Change in Employee Debt",
      format = colFormat(suffix = "%", digits = 2)),
    nominal_difference_ED_c = colDef(
      name = "Nominal Change in Per Capita Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

States3y_sorted_EmployeeDebt_reactable

```

### Cities

```{r, echo=FALSE}

Cities3y_sorted <- Cities3y %>%
  arrange(name, state.abb, year)

Cities3y_sorted_EmployeeDebt <- Cities3y_sorted %>%
  group_by(name) %>%
  mutate(
    nominal_difference_ED = last(employee_debt) - first(employee_debt),
    percent_difference_ED = (last(employee_debt) - first(employee_debt)) / first(employee_debt) * 100,
    nominal_difference_ED_c = last(employee_debt_per_capita) - first(employee_debt_per_capita),
    percent_difference_ED_c = (last(employee_debt_per_capita) - first(employee_debt_per_capita)) / first(employee_debt_per_capita) * 100)

Cities3y_sorted_EmployeeDebt <- Cities3y_sorted_EmployeeDebt %>%
  mutate(employee_debt_per_capita = as.numeric(employee_debt_per_capita)) %>%
  mutate(npl_per_capita = as.numeric(npl_per_capita))


```

```{r, echo=FALSE}

Cities3y_sorted_EmployeeDebt_subset <- Cities3y_sorted_EmployeeDebt %>%
  filter(year == 2022) %>%
  select(name, state.name, employee_debt, employee_debt_per_capita, nominal_difference_ED, percent_difference_ED, nominal_difference_ED_c)

Cities3y_sorted_EmployeeDebt_reactable <- reactable(
  Cities3y_sorted_EmployeeDebt_subset,
  columns = list(
    name = colDef(
      name = "Name",
      cell = function(value) tools::toTitleCase(as.character(value))),  
    state.name = colDef(
      name = "State",
      cell = function(value) tools::toTitleCase(as.character(value))),  
    employee_debt = colDef(
      name = "2022 Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    employee_debt_per_capita = colDef(
      name = "Employee Debt Per Capita",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    nominal_difference_ED = colDef(
      name = "Nominal Change in Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    percent_difference_ED = colDef(
      name = "Percentage Change in Employee Debt",
      format = colFormat(suffix = "%", digits = 2)),
    nominal_difference_ED_c = colDef(
      name = "Nominal Change in Per Capita Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

Cities3y_sorted_EmployeeDebt_reactable

```

### Counties

```{r, echo=FALSE}

Counties3y_sorted <- Counties3y %>%
  arrange(name, state.abb, year)

Counties3y_sorted_EmployeeDebt <- Counties3y_sorted %>%
  group_by(name, state.name) %>%
  mutate(
    nominal_difference_ED = last(employee_debt) - first(employee_debt),
    percent_difference_ED = (last(employee_debt) - first(employee_debt)) / first(employee_debt) * 100,
    nominal_difference_ED_c = last(employee_debt_per_capita) - first(employee_debt_per_capita),
    percent_difference_ED_c = (last(employee_debt_per_capita) - first(employee_debt_per_capita)) / first(employee_debt_per_capita) * 100)

Counties3y_sorted_EmployeeDebt <- Counties3y_sorted_EmployeeDebt %>%
  mutate(employee_debt_per_capita = as.numeric(employee_debt_per_capita)) %>%
  mutate(npl_per_capita = as.numeric(npl_per_capita))


```

```{r, echo=FALSE}

Counties3y_sorted_EmployeeDebt_subset <- Counties3y_sorted_EmployeeDebt %>%
  filter(year == 2022) %>%
  select(name,state.name, employee_debt, employee_debt_per_capita, nominal_difference_ED, percent_difference_ED, nominal_difference_ED_c)

Counties3y_sorted_EmployeeDebt_reactable <- reactable(
  Counties3y_sorted_EmployeeDebt_subset,
  columns = list(
    name = colDef(
      name = "Name",
      cell = function(value) tools::toTitleCase(as.character(value))), 
   state.name = colDef(
      name = "State",
      cell = function(value) tools::toTitleCase(as.character(value))),  
    employee_debt = colDef(
      name = "2022 Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    employee_debt_per_capita = colDef(
      name = "Employee Debt Per Capita",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    nominal_difference_ED = colDef(
      name = "Nominal Change in Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    percent_difference_ED = colDef(
      name = "Percentage Change in Employee Debt",
      format = colFormat(suffix = "%", digits = 2)),
    nominal_difference_ED_c = colDef(
      name = "Nominal Change in Per Capita Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

Counties3y_sorted_EmployeeDebt_reactable

```

### School Districts

```{r, echo=FALSE}

SD3y_sorted <- SD3y %>%
  arrange(name, state.abb, year)

SD3y_sorted_EmployeeDebt <- SD3y_sorted %>%
  group_by(name) %>%
  mutate(
    nominal_difference_ED = last(employee_debt) - first(employee_debt),
    percent_difference_ED = (last(employee_debt) - first(employee_debt)) / first(employee_debt) * 100,
    nominal_difference_ED_c = last(employee_debt_per_capita) - first(employee_debt_per_capita),
    percent_difference_ED_c = (last(employee_debt_per_capita) - first(employee_debt_per_capita)) / first(employee_debt_per_capita) * 100)

SD3y_sorted_EmployeeDebt <- SD3y_sorted_EmployeeDebt %>%
  mutate(employee_debt_per_capita = as.numeric(employee_debt_per_capita)) %>%
  mutate(npl_per_capita = as.numeric(npl_per_student))


```

```{r, echo=FALSE}
SD3y_sorted_EmployeeDebt_subset <- SD3y_sorted_EmployeeDebt %>%
  filter(year == 2022) %>%
  select(name, state.name, employee_debt, employee_debt_per_capita, nominal_difference_ED, percent_difference_ED, nominal_difference_ED_c)

SD3y_sorted_EmployeeDebt_reactable <- reactable(
  SD3y_sorted_EmployeeDebt_subset,
  columns = list(
    name = colDef(
      name = "Name",
      cell = function(value) tools::toTitleCase(as.character(value))),  
     state.name = colDef(
      name = "State",
      cell = function(value) tools::toTitleCase(as.character(value))),  
    employee_debt = colDef(
      name = "2022 Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    employee_debt_per_capita = colDef(
      name = "Employee Debt Per Student",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    nominal_difference_ED = colDef(
      name = "Nominal Change in Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))),
    percent_difference_ED = colDef(
      name = "Percentage Change in Employee Debt",
      format = colFormat(suffix = "%", digits = 2)),
    nominal_difference_ED_c = colDef(
      name = "Nominal Change in Per Student Employee Debt",
      cell = function(value) sprintf("$%s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

SD3y_sorted_EmployeeDebt_reactable

```


# The Budget


## Debt to GDP Ratio 
```{r, echo=FALSE}
States3y <- States3y %>%
  left_join(StateGDP %>% select(state.name, GDP), by = "state.name")

States3y <- States3y %>%
  left_join(PartisanS %>% select(state.name, X2022), by = "state.name")
  
States3y <- States3y %>%
  rename(lean = X2022)

State3y_debtGDP_ratio <- States3y %>%
  filter(year == 2022) %>%
  mutate(debt_to_GDP_ratio = total_liabilities / GDP * 100) %>%
  arrange(debt_to_GDP_ratio)%>%
  select(state.name, debt_to_GDP_ratio, total_liabilities, GDP, lean, net_pension_liability, net_opeb_liability, employee_debt, population, npl_per_capita, employee_debt_per_capita)


ggplot(State3y_debtGDP_ratio, aes(x = GDP, y = debt_to_GDP_ratio)) +
  geom_point() +
  geom_text(aes(label = state.name), vjust = -1, hjust = 1) +
  labs(
    title = "State Debt to GDP Ratio (2022)",
    x = "GDP ($)",
    y = "Debt to GDP Ratio (%)"
  ) +
  theme_minimal() +
  scale_x_continuous(labels = scales::dollar_format()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))+
  theme_reason()


```

```{r, echo=FALSE}

ggplot(State3y_debtGDP_ratio, aes(x = GDP, y = debt_to_GDP_ratio, color = factor(sign(lean)))) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +  
  stat_cor(method = "pearson", aes(group = 1), label.x = 1.5, label.y = 20, label.sep = "\n") +  
  labs(
    title = "State Debt to GDP Ratio (2022)",
    x = "GDP ($)",
    y = "Debt to GDP Ratio (%)",
    color = "Partisan Lean"
  ) +
  scale_x_continuous(labels = scales::dollar_format()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_manual(values = c("red", "blue"), labels = c("Republican leaning", "Democrat leaning")) +
  ggtitle("States: Correlation Between GDP and Debt to GDP Ratio")
```
 

```{r, echo=FALSE}

#| fig-cap: "States: Correlation Between Debt to GDP Ratio and Partisan Lean"

ggplot(State3y_debtGDP_ratio, aes(x = lean, y = debt_to_GDP_ratio, color = factor(sign(lean)))) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +  
  stat_cor(method = "pearson", aes(group = 1), label.x = 1.5, label.y = 20, label.sep = "\n") +  
  labs(
    title = "State Debt to GDP Ratio (2022)",
    x = "Partisan Lean",
    y = "Debt to GDP Ratio (%)",
    color = "Partisan Lean"
  ) +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_manual(values = c("red", "blue"), labels = c("Republican leaning", "Democrat leaning")) +
  ggtitle("States: Correlation Between Partisan Lean and Debt to GDP Ratio")

```

```{r, echo=FALSE}

ggplot(State3y_debtGDP_ratio, aes(x = lean, y = GDP, color = factor(sign(lean)))) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +  
  stat_cor(method = "pearson", aes(group = 1), label.x = 1.5, label.y = 20, label.sep = "\n") +
  labs(
    title = "State Debt to GDP Ratio (2022)",
    x = "Partisan Lean",
    y = "GDP ($)",
    color = "Partisan Lean"
  ) +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_manual(values = c("red", "blue"), labels = c("Republican leaning", "Democrat leaning")) +
  ggtitle("States: Correlation Between GDP and Partisan Lean") 

```


# Statistical Tests

```{r, echo=FALSE}

State3y_debtGDP_ratio_2 <- State3y_debtGDP_ratio %>%
  filter(!is.na(log(lean)), is.finite(log(lean)),
         !is.na(employee_debt_per_capita), is.finite(employee_debt_per_capita)) %>%
  filter(!is.na(log(employee_debt_per_capita)), is.finite(log(employee_debt_per_capita))) %>%
  filter(!is.na(debt_to_GDP_ratio), is.finite(debt_to_GDP_ratio))  %>%
  filter(!is.na(log(population)), is.finite(log(population)),
         !is.na(net_pension_liability), is.finite(net_pension_liability)) %>%
  filter(!is.na(log(net_pension_liability)), is.finite(log(net_pension_liability))) %>%
  filter(!is.na(net_opeb_liability), is.finite(net_opeb_liability)) %>%
  filter(!is.na(log(net_opeb_liability)), is.finite(log(net_opeb_liability)))


```


#### Is partisan Lean as a predictor of debt/gdp ratio? 
Partisan lean explains about 28.13% of the variability in debt_to_GDP_ratio (**) 
```{r, echo=FALSE}
State3y_model_1 <- lm(debt_to_GDP_ratio ~ log(lean), data = State3y_debtGDP_ratio_2)
summary(State3y_model_1)

```

#### Is population as a predictor of Net Pension Liability? 
Population explains 14.98% of the variability in the net pension liability  (***) 
```{r, echo=FALSE}
State3y_model_3 <- lm(net_pension_liability ~ log(population), data = State3y_debtGDP_ratio_2)
summary(State3y_model_3)

```

#### Is population as a predictor of Net OPEB Liability? 
Population explains about 31.21% of the variability in the net OPEB liability  (***) 
```{r, echo=FALSE}
State3y_model_4 <- lm(net_opeb_liability ~ log(population), data = State3y_debtGDP_ratio_2)
summary(State3y_model_4)

```


#### Is partisan lean a good predictor of Net Pension Liability?

There is no significant relationship between partisan lean and net pension liability.

```{r, echo=FALSE}

State3y_model_5 <- lm(lean ~ log(net_pension_liability), data = State3y_debtGDP_ratio_2)
summary(State3y_model_5)

```

#### Is partisan lean a good predictor of Net OPEB Liability?

there is no significant relationship between net OPEB liability and partisan lean

```{r, echo=FALSE}
State3y_model_6 <- lm(lean ~ log(net_opeb_liability), data = State3y_debtGDP_ratio_2)
summary(State3y_model_6)

```

#### Is partisan lean a good predictor of per capita employee debt?

There is no significant relationship between partisan lean and employee debt per capita.

```{r, echo=FALSE}
State3y_model_6 <- lm(employee_debt_per_capita~ log(lean), data = State3y_debtGDP_ratio_2)
summary(State3y_model_6)

```


```{r, echo=FALSE}


State3y_debtGDP_ratio_reactable <- reactable(
  State3y_debtGDP_ratio,
  columns = list(
    state.name = colDef(
      name = "State",
      cell = function(value) tools::toTitleCase(as.character(value))
    ),
    debt_to_GDP_ratio = colDef(
      name = "Debt to GDP Ratio",
      cell = function(value) sprintf("%s", percent(value / 100, accuracy = 0.1))  
    ),
    total_liabilities = colDef(
      name = "Total Liabilities",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))
    ),
    GDP = colDef(
      name = "GDP",
      cell = function(value) sprintf("$%s", format(value, big.mark = ","))
    )
  ),
  defaultPageSize = 10,
  searchable = TRUE
)


State3y_debtGDP_ratio_reactable

```




# Moves in Unfunded Liabiities from 2020-2021

## By Entity 
Moves in Unfunded Liabilities from 2020-2021

#### Figure 1:Total Unfunded Liabilities by Entity from 2020-2022
```{r, echo=FALSE}

Combined3y <- bind_rows(
  mutate(States3y, dataset = "States"),
  mutate(Cities3y, dataset = "Cities"),
  mutate(Counties3y, dataset = "Counties"),
  mutate(SD3y, dataset = "School Districts")
)

Combined3y <- Combined3y %>%
  mutate(population = ifelse(dataset == "School Districts", enrollment_22, population))

total_unfunded_liabilities <- Combined3y %>%
  group_by(year, dataset) %>%
  summarise(total_unfunded_liabilities = sum(net_pension_liability, na.rm = TRUE), .groups = "drop")

total_unfunded_liabilities$dataset <- factor(total_unfunded_liabilities$dataset, levels = c("States", "Cities", "Counties", "School Districts"))


```


```{r, echo=FALSE}

total_unfunded_liabilities <- Combined3y %>%
  group_by(year, dataset) %>%
  summarise(total_unfunded_liabilities = sum(net_pension_liability, na.rm = TRUE), .groups = "drop")

total_unfunded_liabilities$dataset <- factor(total_unfunded_liabilities$dataset, levels = c("States", "Cities", "Counties", "School Districts"))


CensusCities_Counties$name <- trimws(tolower(CensusCities_Counties$name))

Counties3y_C <- inner_join(Counties3y, CensusCities_Counties, by = c("name", "state.abb"))


```


##### Figure 2:Rate of Change in Unfunded Liabilities by Entity from 2020-2022

```{r, echo=FALSE}

States_Total_NPL <- States3y %>%
  group_by(year) %>%
  summarise(TotalOPEB = sum(net_opeb_liability, na.rm = TRUE),
            TotalNPL = sum(net_pension_liability, na.rm = TRUE))

States_Total_NPLchange <- States_Total_NPL %>%
  mutate(change_OPEB = (TotalOPEB - lag(TotalOPEB)) / lag(TotalOPEB) * 100,
         change_NPL = (TotalNPL - lag(TotalNPL)) / lag(TotalNPL) * 100)


SD_Total_NPL <- SD3y %>%
  group_by(year) %>%
  summarise(TotalOPEB = sum(net_opeb_liability, na.rm = TRUE),
            TotalNPL = sum(net_pension_liability, na.rm = TRUE))

SD_Total_NPLchange <- SD_Total_NPL %>%
  mutate(change_OPEB = (TotalOPEB - lag(TotalOPEB)) / lag(TotalOPEB) * 100,
         change_NPL = (TotalNPL - lag(TotalNPL)) / lag(TotalNPL) * 100)


Cities_Total_NPL <- Cities3y %>%
  group_by(year) %>%
  summarise(TotalOPEB = sum(net_opeb_liability, na.rm = TRUE),
            TotalNPL = sum(net_pension_liability, na.rm = TRUE))

Cities_Total_NPLchange <- Cities_Total_NPL %>%
  mutate(change_OPEB = (TotalOPEB - lag(TotalOPEB)) / lag(TotalOPEB) * 100,
         change_NPL = (TotalNPL - lag(TotalNPL)) / lag(TotalNPL) * 100)


Counties_Total_NPL <- Counties3y %>%
  group_by(year) %>%
  summarise(TotalOPEB = sum(net_opeb_liability, na.rm = TRUE),
            TotalNPL = sum(net_pension_liability, na.rm = TRUE))

Counties_Total_NPLchange <- Counties_Total_NPL %>%
  mutate(change_OPEB = (TotalOPEB - lag(TotalOPEB)) / lag(TotalOPEB) * 100,
         change_NPL = (TotalNPL - lag(TotalNPL)) / lag(TotalNPL) * 100)

combined_change_data <- bind_rows(
  States_Total_NPLchange %>% mutate(Dataset = "State"),
  SD_Total_NPLchange %>% mutate(Dataset = "SD"),
  Cities_Total_NPLchange %>% mutate(Dataset = "City"),
  Counties_Total_NPLchange %>% mutate(Dataset = "County")
) %>%
select(change_OPEB,change_NPL, Dataset, year, TotalOPEB, TotalNPL)

orange_colors <- brewer.pal(3, "Reds")


combined_change_data %>%
  ggplot(aes(x = Dataset, y = TotalNPL, fill = factor(year))) +
  geom_col(position = "dodge") +
  geom_text(aes(label = scales::dollar(TotalNPL/1000000000, prefix = "$", suffix = "B", accuracy = 0.1)), 
            position = position_dodge(width = 0.9),
            vjust = -0.5, 
            size = 3, 
            show.legend = FALSE) +  
  labs(
    title = "NPL by Entity",
    x = "Entity",
    y = "Unfunded Liability",
    fill = "Year"
  ) +
  scale_fill_manual(values = orange_colors) +
  theme_minimal() +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$", scale = 1, accuracy = 2)) +  
  coord_flip() +
  theme_reason ()

```

```{r, echo=FALSE}

combined_change_data <- combined_change_data %>%
  group_by(Dataset) %>%
  mutate(
    TotalNPL_20_22 = TotalNPL[year == 2022] - TotalNPL[year == 2020],
    TotalOPEB_20_22 = TotalOPEB[year == 2022] - TotalOPEB[year == 2020],
    TotalNPL_percent_20_22 = (TotalNPL[year == 2022] - TotalNPL[year == 2020]) / TotalNPL[year == 2020],
    TotalOPEB_percent_20_22 = (TotalOPEB[year == 2022] - TotalOPEB[year == 2020]) / TotalOPEB[year == 2020]
  ) %>%
  ungroup()



combined_change_data %>%
  ggplot(aes(x = Dataset, y = TotalOPEB, fill = factor(year))) +
  geom_col(position = "dodge") +
  geom_text(aes(label = scales::dollar(TotalOPEB/1000000000, prefix = "$", suffix = "B", accuracy = 0.1)), 
            position = position_dodge(width = 0.9),
            vjust = -0.5, 
            size = 3, 
            show.legend = FALSE) +  
  labs(
    title = "Net OPEB Liability by Entity",
    x = "Entity",
    y = "Unfunded Liability",
    fill = "Year"
  ) +
  scale_fill_manual(values = orange_colors) +
  theme_minimal() +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$", scale = 1, accuracy = 2)) +  
  coord_flip() +
  theme_reason ()


```

```{r, echo=FALSE}

ggplot(combined_change_data, aes(x = year)) +
  geom_bar(aes(y = TotalNPL, fill = "TotalNPL"), stat = "identity", position = "dodge") +
  geom_bar(aes(y = TotalOPEB, fill = "TotalOPEB"), stat = "identity", position = "dodge") +
  labs(
    title = "TotalOPEB and TotalNPL by Dataset",
    x = "Year",
    y = "Total Value",
    fill = "Legend"
  ) +
  scale_fill_manual(values = c("TotalNPL" = "#FF0000", "TotalOPEB" = "#8B0000")) +
  facet_wrap(~Dataset, scales = "free_y", nrow = 2) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$", scale = 1/1e9, suffix = "B"))+
  theme_reason ()

```


```{r, echo=FALSE}

combined_change_data %>%
  select(Dataset, year, TotalOPEB, TotalNPL) %>%
  mutate(TotalOPEB = scales::dollar_format()(TotalOPEB),
         TotalNPL = scales::dollar_format()(TotalNPL)) %>%
  arrange(Dataset, year) %>%
  knitr::kable(caption = "Combined Change Data Arranged by Dataset") %>%
  kable_styling(full_width = FALSE)


```

```{r, echo=FALSE}

combined_change_data %>%
  filter(year == 2022) %>%
  select(Dataset, TotalNPL_20_22, TotalNPL_percent_20_22, TotalOPEB_20_22, TotalOPEB_percent_20_22) %>%
  mutate(
    TotalNPL_20_22 = dollar(TotalNPL_20_22),
    TotalOPEB_20_22 = dollar(TotalOPEB_20_22),
    TotalNPL_percent_20_22 = percent(TotalNPL_percent_20_22),
    TotalOPEB_percent_20_22 = percent(TotalOPEB_percent_20_22)
  ) %>%
  knitr::kable(col.names = c("Entity", "NPL Change","NPL Percent Change",  "Net OPEB Change", "OPEB Percent Change"), caption = "Changes in Total OPEB Unfunded Liabilities 2020-2022 by Entity") %>%
  kable_styling(full_width = FALSE)


```


## By Population
Moves in Unfunded Liabiities from 2020-2021

#### Cities

##### Figure 3:Correlation between Population and Unfunded Liabilities in 2020 - 2022
```{r, echo=FALSE}

Cities3y_sorted <- Cities3y %>%
  arrange(name, state.abb, year)

cities_NPL_20to22diff <- Cities3y_sorted %>%
  group_by(name, state.abb) %>%
  mutate(
    nominal_difference_NPL20to22 = last(net_pension_liability) - first(net_pension_liability),
    percent_difference_NPL20to22 = (last(net_pension_liability) - first(net_pension_liability)) / first(net_pension_liability) * 100,
    nominal_difference_L20to22 = last(total_liabilities) - first(total_liabilities),
    percent_difference_L20to22 = (last(total_liabilities) - first(total_liabilities)) / first(total_liabilities) * 100,.groups = "drop"

  )

cities_NPL_20to22diff_filter <- cities_NPL_20to22diff %>%
  filter(year == 2022)


Cities3y_sorted <- Cities3y %>%
  arrange(name, state.abb, year)

```


```{r, echo=FALSE}

Combined3y_sorted <- Combined3y %>%
  arrange(name, state.abb, year)

Combined3y_20_22 <- Combined3y_sorted %>%
  group_by(name, state.abb) %>%
  mutate(
    nominal_difference_NPL20to22 = last(net_pension_liability) - first(net_pension_liability),
    percent_difference_NPL20to22 = (last(net_pension_liability) - first(net_pension_liability)) / first(net_pension_liability) * 100,
    nominal_difference_L20to22 = last(total_liabilities) - first(total_liabilities),
    percent_difference_L20to22 = (last(total_liabilities) - first(total_liabilities)) / first(total_liabilities) * 100,.groups = "drop"

  )

Combined3y_20_22_filter <- Combined3y_20_22 %>%
  filter(year == 2022)



```



```{r, echo=FALSE}

colors <- c("#F27E52", "#EBBE5C", "#4B8CC7", "#7CA825")

```

```{r, echo=FALSE}
#| fig-cap: "States: Correlation Between % Difference in NPL Population"

ggplot(Combined3y_20_22_filter %>% filter(dataset == "States"), aes(x = population/1000000, y = percent_difference_NPL20to22)) +
  geom_point(alpha = 0.4, color = "#7CA825") +  # Add dots colored 7CA825 with transparency
  geom_smooth(method = "lm", se = FALSE, color = "black") +  # Add correlation line
  stat_cor(method = "pearson", aes(group = 1), label.x = 1.5, label.y = 20, label.sep = "\n") +  
  labs(x = "Population (Millions)", y = "% Difference NPL 2020 - 2022") +
  ggtitle("States: Correlation Between % Difference in NPL Population") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Limit y-axis from -20% to 20%
  theme_reason()

```

```{r, echo=FALSE}
#| fig-cap: "Cities: Correlation Between % Difference in NPL Population"

ggplot(Combined3y_20_22_filter %>% filter(dataset == "Cities"), aes(x = population/1000, y = percent_difference_NPL20to22)) +
  geom_point(alpha = 0.4, color = "#F27E52") +  # Add dots colored 7CA825 with transparency
  geom_smooth(method = "lm", se = FALSE, color = "black") +  # Add correlation line
  stat_cor(method = "pearson", aes(group = 1), label.x = 1.5, label.y = 20, label.sep = "\n") +  
  labs(x = "Population (Thounsands)", y = "% Difference NPL 2020 - 2022") +
  ggtitle("Cities: Correlation Between % Difference in NPL Population") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Limit y-axis from -20% to 20%
  theme_reason()

```


```{r, echo=FALSE}
#| fig-cap: "Counties: Correlation Between % Difference in NPL Population"

ggplot(Combined3y_20_22_filter %>% filter(dataset == "Counties"), aes(x = population/1000, y = percent_difference_NPL20to22)) +
  geom_point(alpha = 0.4, color = "#EBBE5C") +  # Add dots colored 7CA825 with transparency
  geom_smooth(method = "lm", se = FALSE, color = "black") +  # Add correlation line
  stat_cor(method = "pearson", aes(group = 1), label.x = 1.5, label.y = 20, label.sep = "\n") +  
  labs(x = "Population (Thousands)", y = "% Difference NPL 2020 - 2022") +
  ggtitle("Counties: Correlation Between % Difference in NPL Population") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Limit y-axis from -20% to 20%
  theme_reason()

```

```{r, echo=FALSE}
#| fig-cap: "School Districts: Correlation Between % Difference in NPL Population"

ggplot(Combined3y_20_22_filter %>% filter(dataset == "School Districts"), aes(x = population/1000, y = percent_difference_NPL20to22)) +
  geom_point(alpha = 0.4, color = "#4B8CC7") +  # Add dots colored 7CA825 with transparency
  geom_smooth(method = "lm", se = FALSE, color = "black") +  # Add correlation line
  stat_cor(method = "pearson", aes(group = 1), label.x = 1.5, label.y = 20, label.sep = "\n") +  
  labs(x = "Population (Thousands)", y = "% Difference NPL 2020 - 2022") +
  ggtitle("School Districts: Correlation Between % Difference in NPL Population") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) + 
  theme_reason()

```





```{r, echo=FALSE}
#| fig-cap: "Total Unfunded Liabilities 2020-2022 - Cities divided by Population Quartiles"

Cities3y_q <- Cities3y %>%
  group_by(year) %>%
  mutate(PopulationQuartile = ntile(population, 4))

c_summary_quartiles <- Cities3y_q %>%
  group_by(year, PopulationQuartile) %>%
  summarise(total_liabilities = sum(net_pension_liability, na.rm = TRUE), .groups = 'drop') 

c_summary_quartiles <- c_summary_quartiles %>%
  group_by(PopulationQuartile) %>%
  mutate(
    rate_of_change = (total_liabilities / lag(total_liabilities, default = first(total_liabilities)) - 1) * 100,
    nominal_difference = total_liabilities - lag(total_liabilities, default = first(total_liabilities))
  )

quartile_colors <- c("1" = "#FCD1A2", "2" = "#FCAD6B", "3" = "#FD8D3C", "4" = "#F06813")

ggplot(c_summary_quartiles, aes(x = year, y = total_liabilities, color = as.factor(PopulationQuartile), group = PopulationQuartile)) +
  geom_line() +
  geom_point() +
  labs(
    title = "City Total Liabilities by Population Quartiles 2020-2022",
    x = "Year",
    y = "Total Liabilities",
    color = "Population Quartile:" ) +
  scale_color_manual(values = quartile_colors) +
  scale_y_continuous(labels = scales::dollar_format(scale = 1e-9, suffix = "B")) + 
  theme_reason()



```
```{r, echo=FALSE}
Cities3y_q_2022 <- Cities3y_q %>%
  filter(year == 2022) %>%
  group_by(PopulationQuartile) %>%
  summarise(min_population = min(population, na.rm = TRUE),
            max_population = max(population, na.rm = TRUE))

quartile_data_2022_formatted <- Cities3y_q_2022 %>%
  mutate(across(c(min_population, max_population), ~format(.x, big.mark = ",")))


quartile_data_2022_formatted %>%
  knitr::kable(caption = "Population Ranges of Each City Quartile (2022)", col.names = c("Quartile", "Min", "Max")) %>%
  kable_styling(full_width = FALSE)

```

##### Figure 4:Total Unfunded Liabilities 2020-2022 - Cities divided by Population Quartiles
```{r, echo=FALSE}

c_summary_quartiles_21.22 <- c_summary_quartiles %>%
  filter(year %in% c(2021, 2022))


quartile_colors <- c("1" = "#FCD1A2", "2" = "#FCAD6B", "3" = "#FD8D3C", "4" = "#F06813")

ggplot(c_summary_quartiles_21.22, aes(x = year, y = rate_of_change, color = as.factor(PopulationQuartile), group = PopulationQuartile)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Rate of Change in City Unfunded Liabilities by Population Quartiles",
    x = "Year",
    y = "Rate of Change (%)",
    color = "Population Quartile" ) +
  scale_color_manual(values = quartile_colors) +
  theme_reason()


```
```{r, echo=FALSE}

c_summary_quartiles_21.22 %>%
  arrange(PopulationQuartile) %>%
  mutate(
    `total_liabilities` = scales::dollar(`total_liabilities`),
    `rate_of_change` = scales::percent(`rate_of_change`, scale = 1),
    `nominal_difference` = scales::dollar(`nominal_difference`)
  ) %>%
  knitr::kable(caption = "Changes in City Unfunded Liabilities by Population Quartiles", col.names = c("Year", "Pop Quartile", "Total NPL", "% Change from Previous Year", "$ Change from Previous Year")) %>%
  kable_styling(full_width = FALSE)

```

```{r, echo=FALSE}
selected_columns_cities_NPL_20to22diff_subset <- c("name", "state.abb", "nominal_difference_NPL20to22", "percent_difference_NPL20to22", "nominal_difference_L20to22", "percent_difference_L20to22", "population")
cities_NPL_20to22diff_subset <- cities_NPL_20to22diff_filter[selected_columns_cities_NPL_20to22diff_subset]

cities_NPL_20to22diff_reactable <- reactable(
  cities_NPL_20to22diff_subset,
  columns = list(
    name = colDef(name = "City Name"),
    state.abb = colDef(name = "State"),
    nominal_difference_NPL20to22 = colDef(
      name = "Nominal Change Net Pension Liabilities 2020 - 2022",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    percent_difference_NPL20to22 = colDef(
      name = "Percent Change Net Pension Liabilities 2020 - 2022",
      format = colFormat(suffix = "%", digits = 1)),
    nominal_difference_L20to22 = colDef(
      name = "Nominal Change Total Liabilities 2020 - 2022",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    percent_difference_L20to22 = colDef(
      name = "Percent Change Total Liabilities 2020 - 2022",
      format = colFormat(suffix = "%", digits = 1)),
    population = colDef(
      name = "Population",
      cell = function(value) format(value, big.mark = ",")
    )
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

cities_NPL_20to22diff_reactable
```


## Correlations

```{r, echo=FALSE}

States3y_oo <- States3y %>%
  group_by(year) %>%
summarise(
  NPLtotal = sum(net_pension_liability),
  OpebNtotal = sum(net_opeb_liability)
)

```


```{r, echo=FALSE}

counties_NPL_20to22diff_OPEB <- Counties3y %>%
  group_by(name, state.abb) %>%
  mutate(
    nominal_difference_OPEB20to22 = last(net_opeb_liability) - first(net_opeb_liability),
    percent_difference_OPEB20to22 = (last(net_opeb_liability) - first(net_opeb_liability)) / first(net_opeb_liability) * 100,
  )
 
counties_NPL_20to22diff_OPEB_filter <- counties_NPL_20to22diff_OPEB %>%
  filter(year == 2022)


```

```{r, echo=FALSE}

Counties3y_C <- inner_join(counties_NPL_20to22diff_OPEB, CensusCities_Counties, by = c("name", "state.abb"))

Counties3y_C_capita <- Counties3y_C %>%
  mutate(
    opeb_L_capita = net_opeb_liability / population, 
    total_L_capita = net_pension_liability / population 
  )


```

```{r, echo=FALSE}
#County Calculations
Counties3y_C_2 <- subset(Counties3y_C_capita, select = -c(X.x, X.y, year, state.abb, state.name, geo_id, id, name, net_pension_assets,net_opeb_assets,net_opeb_liability, median_hh_income_21, current_liabilities, total_liabilities, net_pension_liability, net_opeb_liability, expenses, revenues, urban_pop, Poverty.Estimate..Age.0.17, Poverty.Estimate..All.Ages, Poverty.Percent..Age.0.17))

Counties3y_C_2[] <- lapply(Counties3y_C_2, function(x) {
  x <- as.numeric(as.character(x))
  x[!is.finite(x)] <- NA  # Replace non-finite values with NA
  return(x)
})

# Remove rows with any NA values (you might consider a different strategy based on your data needs)
Counties3y_C_2 <- na.omit(Counties3y_C_2)

corCounties <- cor(Counties3y_C_2, use = "pairwise.complete.obs")



```


```{r, echo=FALSE}

States3y_2 <- subset(States3y, select = -c(X, year, state.abb, state.name, geo_id, name, net_pension_assets, revenues))
corStates <- cor(States3y_2)

# For Cities3y
Cities3y_2 <- subset(Cities3y, select = -c(X, year, state.abb, state.name, geo_id, name, net_pension_assets))
corCities <- cor(Cities3y_2)

# For SD3y
SD3y_2 <- subset(SD3y, select = -c(X, state.abb, state.name, ncesID, name, city, county, locale, year, net_pension_assets, net_opeb_assets, id))


```


### States
```{r, echo=FALSE}
melted_corStates <- melt(corStates)

ggplot(melted_corStates, aes(Var1, Var2, fill = value)) +
  geom_tile() +  
  geom_text(aes(label = sprintf("%.2f", value)), color = "black", size = 3) +  
  scale_fill_gradient2(low = "red", high = "green", mid = "gray", midpoint = 0) +  
  theme_minimal() +  
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.text.y = element_text(angle = 45, hjust = 1)  
  ) +
  labs(
    title = "Correlation Matrix: States",  
    x = "",  
    y = "",  
    fill = "Correlation Strength" 
  )

```


### Cities
```{r, echo=FALSE}
melted_corStates <- melt(corCities)

ggplot(melted_corStates, aes(Var1, Var2, fill = value)) +
  geom_tile() +  
  geom_text(aes(label = sprintf("%.2f", value)), color = "black", size = 3) +  
  scale_fill_gradient2(low = "red", high = "green", mid = "gray", midpoint = 0) +  
  theme_minimal() +  
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.text.y = element_text(angle = 45, hjust = 1)  
  ) +
  labs(
    title = "Correlation Matrix: Cities",  
    x = "",  
    y = "",  
    fill = "Correlation Strength" 
  )

```

### Counties
```{r, echo=FALSE}

corCounties <- melt(corCounties)

ggplot(corCounties, aes(Var1, Var2, fill = value)) +
  geom_tile() +  
  geom_text(aes(label = sprintf("%.2f", value)), color = "black", size = 3) +  
  scale_fill_gradient2(low = "red", high = "green", mid = "gray", midpoint = 0) +  
  theme_minimal() +  
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
  ) +
  labs(
    title = "Correlation Matrix: Counties",  
    x = "",  
    y = "",  
    fill = "Correlation Strength" 
  )


```


### School Districts 
melted_corStates <- melt(corSD)

ggplot(melted_corStates, aes(Var1, Var2, fill = value)) +
  geom_tile() +  
  geom_text(aes(label = sprintf("%.2f", value)), color = "black", size = 3) +  
  scale_fill_gradient2(low = "red", high = "green", mid = "gray", midpoint = 0) +  
  theme_minimal() +  
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    axis.text.y = element_text(angle = 45, hjust = 1)  
  ) +
  labs(
    title = "Correlation Matrix: School Districts",  
    x = "",  
    y = "",  
    fill = "Correlation Strength" 
  )



## OPEB 

### What happened from 2020 to 2022?

```{r, echo=FALSE}

total_OPEB_liabilities <- Combined3y %>%
  group_by(dataset, year) %>%
  summarize(OPEB_npl = sum(net_opeb_liability, na.rm = TRUE), .groups = "drop")

total_OPEB_liabilities <- total_OPEB_liabilities %>%
   arrange(dataset, year)

total_OPEB_liabilities <- total_OPEB_liabilities %>%
  mutate(
    first_total_OPEB = first(OPEB_npl),
    last_total_OPEB = last(OPEB_npl),
    OPEB_nominal_difference_NPL20to22 = last_total_OPEB - first_total_OPEB,
    OPEB_percent_difference_NPL20to22 = ((last_total_OPEB - first_total_OPEB) / first_total_OPEB) * 100,
    OPEB_nominal_difference_L20to22 = last_total_OPEB - first_total_OPEB,  
    OPEB_percent_difference_L20to22 = ((last_total_OPEB - first_total_OPEB) / first_total_OPEB) * 100,
    .groups = "drop"
  )


```

```{r, echo=FALSE}

total_OPEB_liabilities %>%
  ggplot(aes(x = dataset, y = OPEB_npl, fill = factor(year))) +
  geom_col(position = "dodge") +
  geom_text(aes(label = dollar(OPEB_npl/1000000000, prefix = "$", suffix = "B", accuracy = 0.1)), 
            position = position_dodge(width = 0.9),
            vjust = -0.5, 
            size = 3, 
            show.legend = FALSE,
            hjust = 0.5) +  # Adjusted for better label positioning
  labs(
    title = "Change in Unfunded OPEB Liabilities by Entity",
    x = "Entity",
    y = "Unfunded Liability",
    fill = "Year"
  ) +
  scale_fill_manual(values = c(orange_colors)) +  
  theme_minimal() +
  scale_y_continuous(labels = dollar_format(prefix = "$", scale = 1, accuracy = 1)) +  
  coord_flip()


```


```{r, echo=FALSE}

combined_change_data %>%
  filter(year == 2022) %>%
  select(Dataset, year, TotalOPEB_20_22, TotalOPEB_percent_20_22) %>%
  mutate(
    TotalOPEB_20_22 = dollar(TotalOPEB_20_22),
    TotalOPEB_percent_20_22 = percent(TotalOPEB_percent_20_22)
  ) %>%
  knitr::kable(col.names = c("Entity", "Year", "Net OPEB Change", "OPEB Percent Change"), caption = "Changes in Total OPEB Unfunded Liabilities 2020-2022 by Entity") %>%
  kable_styling(full_width = FALSE)



```





### States

```{r, echo=FALSE}

combined_change_data %>%
  filter(Dataset == "State") %>%
  select(year, TotalOPEB_20_22, TotalOPEB_percent_20_22) %>%
  mutate(
    TotalOPEB_20_22 = dollar(TotalOPEB_20_22),
    TotalOPEB_percent_20_22 = percent(TotalOPEB_percent_20_22)
  ) %>%
  knitr::kable(col.names = c("Year", "Net OPEB Change", "OPEB Percent Change"), caption = "Changes in State OPEB Unfunded Liabilities 2020-2022") %>%
  kable_styling(full_width = FALSE)


```

```{r, echo=FALSE}

states_NPL_20to22diff_OPEB <- States3y %>%
  group_by(name, state.abb) %>%
  mutate(
    nominal_difference_OPEB20to22 = last(net_opeb_liability) - first(net_opeb_liability),
    percent_difference_OPEB20to22 = (last(net_opeb_liability) - first(net_opeb_liability)) / first(net_opeb_liability) * 100,
  )
 
states_NPL_20to22diff_OPEB_filter <- states_NPL_20to22diff_OPEB %>%
  filter(year == 2022)


```


```{r, echo=FALSE}

selected_columns_states_OPEB_20to22diff_subset <- c("name", "nominal_difference_OPEB20to22", "percent_difference_OPEB20to22","net_opeb_liability")
states_OPEB_20to22diff_subset <- states_NPL_20to22diff_OPEB_filter[selected_columns_states_OPEB_20to22diff_subset]

states_OPEB_20to22diff_reactable <- reactable(
  states_OPEB_20to22diff_subset,
  columns = list(
    name = colDef(name = "City"),
    nominal_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability $ Difference 20->22",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    percent_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability % Difference 20->22",
      cell = function(value) sprintf("%.2f %%", value)), # Changed here
    net_opeb_liability = colDef(
      name = "Net OPEB Liability in 2022",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

states_OPEB_20to22diff_reactable

```

### Cities


```{r, echo=FALSE}

Cities3yy_sorted <- Cities3y %>%
  arrange(name, state.abb, year)


Cities_NPL_20to22diff_OPEB <- Cities3yy_sorted %>%
  group_by(name, state.abb) %>%
  mutate(
    nominal_difference_OPEB20to22 = last(net_opeb_liability) - first(net_opeb_liability),
    percent_difference_OPEB20to22 = (last(net_opeb_liability) - first(net_opeb_liability)) / first(net_opeb_liability) * 100,
  )
 
Cities_NPL_20to22diff_OPEB_filter <- Cities_NPL_20to22diff_OPEB %>%
  filter(year == 2022)


```


```{r, echo=FALSE}

selected_columns_cities_OPEB_20to22diff_subset <- c("name", "state.abb", "nominal_difference_OPEB20to22", "percent_difference_OPEB20to22","net_opeb_liability")
Cities_OPEB_20to22diff_subset <- Cities_NPL_20to22diff_OPEB_filter[selected_columns_cities_OPEB_20to22diff_subset]

Cities_OPEB_20to22diff_reactable <- reactable(
 Cities_OPEB_20to22diff_subset,
  columns = list(
    name = colDef(name = "City"),
    state.abb = colDef(name = "State"),
    nominal_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability $ Difference 20->22",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    percent_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability % Difference 20->22",
      cell = function(value) sprintf("%.2f %%", value)), # Changed here
    net_opeb_liability = colDef(
      name = "Net OPEB Liability in 2022",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

Cities_OPEB_20to22diff_reactable

```



```{r, echo=FALSE}

cities_NPL_20to22diff_OPEB <- Cities3y_sorted %>%
  group_by(name, state.abb) %>%
  mutate(
    nominal_difference_OPEB20to22 = last(net_opeb_liability) - first(net_opeb_liability),
    percent_difference_OPEB20to22 = (last(net_opeb_liability) - first(net_opeb_liability)) / first(net_opeb_liability) * 100,
  )
 
cities_NPL_20to22diff_OPEB_filter <- cities_NPL_20to22diff_OPEB %>%
  filter(year == 2022)


```


```{r, echo=FALSE}

selected_columns_cities_OPEB_20to22diff_subset <- c("name", "state.abb", "nominal_difference_OPEB20to22", "percent_difference_OPEB20to22","net_opeb_liability")
cities_OPEB_20to22diff_subset <- cities_NPL_20to22diff_OPEB_filter[selected_columns_cities_OPEB_20to22diff_subset]

cities_OPEB_20to22diff_reactable <- reactable(
  cities_OPEB_20to22diff_subset,
  columns = list(
    name = colDef(name = "City"),
    state.abb = colDef(name = "State"),
    nominal_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability $ Difference 20->22",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    percent_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability % Difference 20->22",
      cell = function(value) sprintf("%.2f %%", value)), # Changed here
    net_opeb_liability = colDef(
      name = "Net OPEB Liability in 2022",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

cities_OPEB_20to22diff_reactable

```

### School Districs
```{r, echo=FALSE}

SD3y_sorted <- SD3y %>%
  arrange(name, state.abb, year)


SD_NPL_20to22diff_OPEB <- SD3y_sorted %>%
  group_by(name, state.abb) %>%
  mutate(
    nominal_difference_OPEB20to22 = last(net_opeb_liability) - first(net_opeb_liability),
    percent_difference_OPEB20to22 = (last(net_opeb_liability) - first(net_opeb_liability)) / first(net_opeb_liability) * 100,
  )
 
SD_NPL_20to22diff_OPEB_filter <- SD_NPL_20to22diff_OPEB %>%
  filter(year == 2022)


```


```{r, echo=FALSE}

selected_columns_cities_OPEB_20to22diff_subset <- c("name", "state.abb", "nominal_difference_OPEB20to22", "percent_difference_OPEB20to22","net_opeb_liability")
SD_OPEB_20to22diff_subset <- SD_NPL_20to22diff_OPEB_filter[selected_columns_cities_OPEB_20to22diff_subset]

SD_OPEB_20to22diff_reactable <- reactable(
  SD_OPEB_20to22diff_subset,
  columns = list(
    name = colDef(name = "School Distric"),
    state.abb = colDef(name = "State"),
    nominal_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability $ Difference 20->22",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    percent_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability % Difference 20->22",
      cell = function(value) sprintf("%.2f %%", value)), # Changed here
    net_opeb_liability = colDef(
      name = "Net OPEB Liability in 2022",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

SD_OPEB_20to22diff_reactable

```

### Counties


```{r, echo=FALSE}

selected_columns_counties_OPEB_20to22diff_subset <- c("name", "state.abb", "nominal_difference_OPEB20to22", "percent_difference_OPEB20to22","net_opeb_liability")
counties_OPEB_20to22diff_subset <- counties_NPL_20to22diff_OPEB_filter[selected_columns_counties_OPEB_20to22diff_subset]

counties_OPEB_20to22diff_reactable <- reactable(
  counties_OPEB_20to22diff_subset,
  columns = list(
    name = colDef(name = "County"),
    state.abb = colDef(name = "State"),
    nominal_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability $ Difference 20->22",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    percent_difference_OPEB20to22 = colDef(
      name = "Net OPEB Liability % Difference 20->22",
      cell = function(value) sprintf("%.2f %%", value)), # Changed here
    net_opeb_liability = colDef(
      name = "Net OPEB Liability in 2022",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

counties_OPEB_20to22diff_reactable

```

# Asset Analysis 

## Debt Ratio 

```{r, echo=FALSE}

States3y <- States3y %>%
  mutate(debt_ratio = total_assets / total_liabilities) %>%
  filter(!is.na(debt_ratio))

Cities3y <- Cities3y %>%
  mutate(debt_ratio = total_assets / total_liabilities) %>%
  filter(!is.na(debt_ratio))

Counties3y <- Counties3y %>%
  mutate(debt_ratio = total_assets / total_liabilities) %>%
  filter(!is.na(debt_ratio))

SD3y <- SD3y %>%
  mutate(debt_ratio = total_assets / total_liabilities) %>%
  filter(!is.na(debt_ratio))


```

### Debt Ratio of States (2022)

```{r, echo=FALSE}

States3y_debt_subset <- States3y %>%
  filter(year == 2022) %>%
  arrange(debt_ratio)

selected_columns_debt_retractable <- c("name", "debt_ratio", "total_assets","total_liabilities")
States3y_debt_subset <- States3y_debt_subset[selected_columns_debt_retractable]

States3y_debt_subset_reactable <- reactable(
  data = States3y_debt_subset,
  columns = list(
    name = colDef(name = "State"),
    debt_ratio = colDef(
      name = "Debt Ratio",
      cell = function(value) sprintf("%.2f %%", value * 100)), # Multiplied by 100 here
    total_assets = colDef(
      name = "Total Asset",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    total_liabilities = colDef(
      name = "Total Liabilities",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE,
)

States3y_debt_subset_reactable


```

### Debt Ratio of Cities (2022)

```{r, echo=FALSE}

Cities3y_debt_subset <- Cities3y %>%
  filter(year == 2022) %>%
  arrange(debt_ratio)

selected_columns_debt_retractable <- c("name", "debt_ratio", "total_assets","total_liabilities")
Cities3y_debt_subset <- Cities3y_debt_subset[selected_columns_debt_retractable]

Cities3y_debt_subset_reactable <- reactable(
  data = Cities3y_debt_subset,
  columns = list(
    name = colDef(name = "State"),
    debt_ratio = colDef(
      name = "Debt Ratio",
      cell = function(value) sprintf("%.2f %%", value * 100)), # Multiplied by 100 here
    total_assets = colDef(
      name = "Total Asset",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    total_liabilities = colDef(
      name = "Total Liabilities",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE,
)

Cities3y_debt_subset_reactable


```

### Debt Ratio of Counties (2022)

```{r, echo=FALSE}

Counties3y_debt_subset <- Counties3y %>%
  filter(year == 2022) %>%
  arrange(debt_ratio)

selected_columns_debt_retractable <- c("name", "debt_ratio", "total_assets","total_liabilities")
Counties3y_debt_subset <- Counties3y_debt_subset[selected_columns_debt_retractable]

Counties3y_debt_subset_reactable <- reactable(
  data = Counties3y_debt_subset,
  columns = list(
    name = colDef(name = "State"),
    debt_ratio = colDef(
      name = "Debt Ratio",
      cell = function(value) sprintf("%.2f %%", value * 100)), # Multiplied by 100 here
    total_assets = colDef(
      name = "Total Asset",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    total_liabilities = colDef(
      name = "Total Liabilities",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE,
)

Counties3y_debt_subset_reactable


```



### School Districts Debt Ratio (2022)

```{r, echo=FALSE}

SD3y_debt_subset <- SD3y %>%
  filter(year == 2022) %>%
  arrange(debt_ratio)

selected_columns_debt_retractable <- c("name", "state.abb", "debt_ratio", "total_assets","total_liabilities")
SD3y_debt_subset <- SD3y_debt_subset[selected_columns_debt_retractable]

SD3y_debt_subset_reactable <- reactable(
  data = SD3y_debt_subset,
  columns = list(
    name = colDef(name = "School District"),
    state.abb = colDef(name = "State"),
    debt_ratio = colDef(
      name = "Debt Ratio",
      cell = function(value) sprintf("%.2f %%", value * 100)), # Multiplied by 100 here
    total_assets = colDef(
      name = "Total Asset",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    total_liabilities = colDef(
      name = "Total Liabilities",
      cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE,
)

SD3y_debt_subset_reactable


```



# The Governmental Units

## States


```{r, echo=FALSE}

ggplot(States_Total_NPL, aes(x = year, y = TotalNPL)) + 
  geom_col(fill = "#7CA825") +
  geom_text(aes(label = paste0(dollar_format()(TotalNPL / 1000000000), " B")),
            position = position_stack(vjust = 0.5), color = "black", size = 3) +
  labs(title = "Top 100 States Net Pension Liability 2020 - 2022", x = "Year", y = "Total Unfunded Liability") +
  scale_y_continuous(breaks = pretty_breaks(n = 10),
                     labels = function(x) paste0(dollar_format(scale = 1/1000000000)(x), "B")) +
  theme_reason() +
  theme(legend.title = element_blank())


```

```{r, echo=FALSE}

States_Total_NPLchange %>%
  select(year, TotalNPL, change_NPL) %>%
  mutate(
    TotalNPL = scales::dollar_format(prefix = "$", accuracy = 0.01)(TotalNPL),
    change_NPL = scales::percent_format(accuracy = 0.01)((change_NPL / 100))
  ) %>%
  kable(format = "html", col.names = c("", "", "")) %>%
  kable_styling() %>%
  add_header_above(c("State Total Net Pension Liability" = 3), escape = FALSE) %>%
  kable_styling(full_width = FALSE)


``` 
 
 
### The States in 2022
```{r, echo=FALSE}
selected_columns <- c("name", "net_pension_liability", "npl_per_capita", "net_opeb_liability", "revenues")

subset_states3y <- States3y %>%
  filter(year == 2022) %>%
  select(all_of(selected_columns))

reactable(
  data = subset_states3y,
  filterable = TRUE,
  defaultSorted = list(net_pension_liability = "desc"),
  columns = list(
    name = colDef(name = "State"),
    net_pension_liability = colDef(name = "Net Pension Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    npl_per_capita = colDef(name = "Net Pension Liability Per Capita", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    net_opeb_liability = colDef(name = "Net OPEB Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    revenues = colDef(name = "Revenues", cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)


```


### Top 10 States by Liabilities 2022
```{r, echo=FALSE}
top_states_2022 <- States3y %>%
  filter(year == 2022) %>%
  arrange(desc(net_pension_liability)) %>%
  slice(1:10) %>%
  select("State" = state.name,"Net Pension Liability" = net_pension_liability,"Per Capita" = npl_per_capita)
 
top_states_2022 <- top_states_2022 %>%
  mutate_at(vars("Net Pension Liability", "Per Capita"), scales::dollar)

 
html_table <- top_states_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)


html_table

```


### Top 10 States by Per Capita Liabilities 2022
```{r, echo=FALSE}

top_states_PC_2022 <- States3y %>%
  filter(year == 2022) %>%
  arrange(desc(npl_per_capita)) %>%
  slice(1:10) %>%
  select("State" = state.name,"Per Capita NPL" = npl_per_capita, "Total NPL" = net_pension_liability,)
 
top_states_PC_2022 <- top_states_PC_2022 %>%
  mutate_at(vars("Per Capita NPL", "Total NPL"), scales::dollar)

 
html_table <- top_states_PC_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)


html_table

```


## Cities

```{r, echo=FALSE}

ggplot(Cities_Total_NPL, aes(x = year, y = TotalNPL)) + 
  geom_col(fill = "#F27E52") +
  geom_text(aes(label = paste0(dollar_format()(TotalNPL / 1000000000), "B")),
            position = position_stack(vjust = 0.5), color = "black", size = 3) +
  labs(title = "Top 100 Cities Net Pension Liability 2020 - 2022", x = "Year", y = "Total Unfunded Liability") +
  scale_y_continuous(breaks = pretty_breaks(n = 10),
                     labels = function(x) paste0(dollar_format(scale = 1/1000000000)(x), "B")) +
  theme_reason() +
  theme(legend.title = element_blank())


```

```{r, echo=FALSE}

Cities_Total_NPLchange %>%
  select(year, TotalNPL, change_NPL) %>%
  mutate(
    TotalNPL = scales::dollar_format(prefix = "$", accuracy = 0.01)(TotalNPL),
    change_NPL = scales::percent_format(accuracy = 0.01)((change_NPL / 100))
  ) %>%
  kable(format = "html", col.names = c("", "", "")) %>%
  kable_styling() %>%
  add_header_above(c("Cities Total Net Pension Liability" = 3), escape = FALSE) %>%
  kable_styling(full_width = FALSE)


``` 



### The Cities in 2022
```{r, echo=FALSE}

subset_cities3y <- Cities3y %>%
  filter(year == 2022) %>%
  select(c("name", "state.abb", "net_pension_liability", "npl_per_capita", "net_opeb_liability", "revenues","population"))



reactable(
  data = subset_cities3y,
  filterable = TRUE,
  defaultSorted = list(net_pension_liability = "desc"),
  columns = list(
    name = colDef(name = "City"),
    state.abb = colDef(name = "State"),
    population = colDef(name = "Population", cell = function(value) sprintf(format(value, big.mark = ","))),
    net_pension_liability = colDef(name = "Net Pension Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    npl_per_capita = colDef(name = "Net Pension Liability Per Capita", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    net_opeb_liability = colDef(name = "Net OPEB Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    revenues = colDef(name = "Revenues", cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

```


### Top 10 Cities by Liabilities 2022
```{r, echo=FALSE}

top_cities_2022 <- Cities3y %>%
  filter(year == 2022) %>%
  arrange(desc(net_pension_liability)) %>%
  slice(1:10) %>%
  select("City" = name, "State" = state.abb,"Net Pension Liability" = net_pension_liability,"Per Capita" = npl_per_capita)
 
top_cities_2022 <- top_cities_2022 %>%
  mutate_at(vars("Net Pension Liability", "Per Capita"), scales::dollar)

 
html_table <- top_cities_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)


html_table

```


#### Top 10 Cities by Per Capita Liabilities 2022
```{r, echo=FALSE}

top_cities_PC_2022 <- Cities3y %>%
  filter(year == 2022) %>%
  arrange(desc(npl_per_capita)) %>%
  slice(1:10) %>%
  select("City" = name, "State" = state.abb,"Per Capita NPL" = npl_per_capita,"Total NPL" = net_pension_liability)
 
top_cities_PC_2022 <- top_cities_PC_2022 %>%
  mutate_at(vars("Total NPL", "Per Capita NPL"), scales::dollar)

 
html_table <- top_cities_PC_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)


html_table

```

## Counties
```{r, echo=FALSE}

ggplot(Counties_Total_NPL, aes(x = year, y = TotalNPL)) + 
  geom_col(fill = "#EBBE5C") +
  geom_text(aes(label = paste0(dollar_format()(TotalNPL / 1000000000), "B")),
            position = position_stack(vjust = 0.5), color = "black", size = 3) +
  labs(title = "Top 100 Counties Net Pension Liability 2020 - 2022", x = "Year", y = "Total Unfunded Liability") +
  scale_y_continuous(breaks = pretty_breaks(n = 10),
                     labels = function(x) paste0(dollar_format(scale = 1/1000000000)(x), "B")) +
  theme_reason() +
  theme(legend.title = element_blank())


```

```{r, echo=FALSE}

Counties_Total_NPLchange %>%
  select(year, TotalNPL, change_NPL) %>%
  mutate(
    TotalNPL = scales::dollar_format(prefix = "$", accuracy = 0.01)(TotalNPL),
    change_NPL = scales::percent_format(accuracy = 0.01)((change_NPL / 100))
  ) %>%
  kable(format = "html", col.names = c("", "", "")) %>%
  kable_styling() %>%
  add_header_above(c("Counties Total Net Pension Liability" = 3), escape = FALSE) %>%
  kable_styling(full_width = FALSE)


``` 




#### The Counties in 2022
```{r, echo=FALSE}

subset_counties3y <- Counties3y %>%
  filter(year == 2022) %>%
  select(c("name", "state.abb", "net_pension_liability", "npl_per_capita", "net_opeb_liability", "revenues"))

reactable(
  data = subset_counties3y,
  filterable = TRUE,
  defaultSorted = list(net_pension_liability = "desc"),
  columns = list(
    name = colDef(name = "County"),
    state.abb = colDef(name = "State"),
    net_pension_liability = colDef(name = "Net Pension Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    npl_per_capita = colDef(name = "Net Pension Liability Per Capita", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    net_opeb_liability = colDef(name = "Net OPEB Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    revenues = colDef(name = "Revenues", cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

```

### Top 10 Counties by Net Pension Liabilities 2022
```{r, echo=FALSE}
top_counties_2022 <- Counties3y %>%
  filter(year == 2022) %>%
  arrange(desc(net_pension_liability)) %>%
  slice(1:10) %>%
  select("County" = name, "State" = state.abb,"Net Pension Liability" = net_pension_liability,"Per Capita" = npl_per_capita)
 
top_counties_2022 <- top_counties_2022 %>%
  mutate_at(vars("Net Pension Liability", "Per Capita"), scales::dollar)

 
html_table <- top_counties_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)


html_table

```

### Top 10 County by Per Capita Liabilities in 2022
```{r, echo=FALSE}
top_counties_PC_2022 <- Counties3y %>%
  filter(year == 2022) %>%
  arrange(desc(npl_per_capita)) %>%
  slice(1:10) %>%
   select("County" = name, "State" = state.abb,"Per Capita" = npl_per_capita, "Total NPL" = net_pension_liability)
 
top_counties_PC_2022 <- top_counties_PC_2022 %>%
  mutate_at(vars("Total NPL", "Per Capita"), scales::dollar)

 
html_table <- top_counties_PC_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)


html_table
```


## School Districts

```{r, echo=FALSE}

ggplot(SD_Total_NPL, aes(x = year, y = TotalNPL)) + 
  geom_col(fill = "#4B8CC7") +
  geom_text(aes(label = paste0(dollar_format()(TotalNPL / 1000000000), "B")),
            position = position_stack(vjust = 0.5), color = "black", size = 3) +
  labs(title = "Top 100 States Net Pension Liability 2020 - 2022", x = "Year", y = "Total Unfunded Liability") +
  scale_y_continuous(breaks = pretty_breaks(n = 10),
                     labels = function(x) paste0(dollar_format(scale = 1/1000000000)(x), "B")) +
  theme_reason() +
  theme(legend.title = element_blank())


```

```{r, echo=FALSE}

SD_Total_NPLchange %>%
  select(year, TotalNPL, change_NPL) %>%
  mutate(
    TotalNPL = scales::dollar_format(prefix = "$", accuracy = 0.01)(TotalNPL),
    change_NPL = scales::percent_format(accuracy = 0.01)((change_NPL / 100))
  ) %>%
  kable(format = "html", col.names = c("", "", "")) %>%
  kable_styling() %>%
  add_header_above(c("School Districts Total Net Pension Liability" = 3), escape = FALSE) %>%
  kable_styling(full_width = FALSE)


``` 

### The School Districts in 2022
```{r, echo=FALSE}

subset_SD3y <- SD3y %>%
  filter(year == 2022) %>%
  select(c("name", "state.abb", "net_pension_liability", "npl_per_student", "net_opeb_liability", "revenues"))

reactable(
  data = subset_SD3y,
  filterable = TRUE,
  defaultSorted = list(net_pension_liability = "desc"),
  columns = list(
    name = colDef(name = "School District"),
    state.abb = colDef(name = "State"),
    net_pension_liability = colDef(name = "Net Pension Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    npl_per_student = colDef(name = "Net Pension Liability Per Student", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    net_opeb_liability = colDef(name = "Net OPEB Liability", cell = function(value) sprintf("$ %s", format(value, big.mark = ","))),
    revenues = colDef(name = "Revenues", cell = function(value) sprintf("$ %s", format(value, big.mark = ",")))
  ),
  defaultPageSize = 10,
  searchable = TRUE
)

```

### Top 10 School Districts by Liabilities 2022
```{r, echo=FALSE}
top_SD_2022 <- SD3y %>%
  filter(year == 2022) %>%
  arrange(desc(net_pension_liability)) %>%
  slice(1:10) %>%
  select("County" = name, "State" = state.abb,"Net Pension Liability" = net_pension_liability,"Per Student" = npl_per_student)
 
top_SD_2022 <- top_SD_2022 %>%
  mutate_at(vars("Net Pension Liability", "Per Student"), scales::dollar)

 
html_table <- top_SD_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)

html_table
```

### Top 10 School Districts by Per Student Liabilities in 2022
```{r, echo=FALSE}
top_PS_SD_2022 <- SD3y %>%
  filter(year == 2022) %>%
  arrange(desc(npl_per_student)) %>%
  slice(1:10) %>%
  select("County" = name, "State" = state.abb,"Per Student Net Pension Liability" = npl_per_student,"Total NPL" = net_pension_liability,)
 
top_PS_SD_2022 <- top_PS_SD_2022 %>%
  mutate_at(vars("Per Student Net Pension Liability", "Total NPL"), scales::dollar)

 
html_table_top_SD_2022 <- top_PS_SD_2022 %>%
  kable() %>%
  kable_styling(full_width = FALSE)

html_table_top_SD_2022
```




